<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div class="mixpanel-platform-section">
        <div id="eventName" style="float: left;"></div>
         <div id="dateSelect" style="float: right;"></div>
        <div style="clear: left"></div>
        <div style="clear: both;"></div>
       
        <div id="graph"></div>
        <div id = "graph2"></div>
    </div>
    <script>
     var dateSelect = $('#dateSelect').MPDatepicker();
      // MP.api.ready(function() {
        // replace with event name of your choice
        // var eventName = $('#eventName').MPEventSelect();
        eventName = 'App-View-Video' //change event name here
        
        getDates = function() {
          return dateSelect.MPDatepicker('value')
        }
       

        var runQuery = function() {
          //$('#graph').empty();
          var y = {}
          y[eventName] = {}
          var final = {}
          final[eventName] = {}
          var $dau = MP.api.segment(eventName, {
            // from: moment(getDates().from).subtract(30, 'days'),
            // to: moment(getDates().to).subtract(1, 'days'),
            from: getDates().from,
            to: getDates().to,
            unit: 'week',
            event: eventName,
            type: 'unique', //you can add an event name here, instead of using event selector
            where: 'properties["gt_Subscriber"] == true and ("Android" in properties["gt_OS"]) and (defined (properties["gt_OS"]))' //where param for property filters
          });
          
          var d_a = ["2016-09-10", "2016-10-10"]
          var $mau = function(date_array){
            _.each(date_array, function(dte){
              var dtei = new Date(dte).getTime() -  2.592e9 + 8.64e+7
              var dtef = new Date(dtei).toISOString().substr(0, 10)
              console.log ("DTE " + dte)
              console.log( "DTEF " + dtef)
            
              var x = MP.api.segment(eventName, {
                from: dtef,
                to: dte,
                type: 'unique',
                interval: 30,
                where: 'properties["gt_Subscriber"] == true and ("Android" in properties["gt_OS"]) and (defined (properties["gt_OS"]))'
              });
              $.when(x).done(function(item){
                y[eventName][dte] = item.values()[eventName][dtef]
                // console.log(y)
              })
            })
            return y
          }
          // $mau(d_a)
          
          var getArray = $.when($dau).done(function(dau){
            console.log("getArray outpu "+ $mau(_.keys(dau.values()[eventName])))
            return $mau(_.keys(dau.values()[eventName]))
            // console.log($mau(_.keys(dau.values()[eventName])))
            // console.log(dau)
            // var kk = _.keys(dau.values()[eventName])
            // _.each(kk, function(k){
            //   final_output[eventName][k] = dau.values()[eventName][k] / gc
            // })
            // return _.keys(dau.values()[eventName])
          })
          
          var finalize = $.when(getArray, $dau).done(function(ga, dau){
            var kk = _.keys(dau.values()[eventName])
            console.log ("mau values" + ga.values()[eventName][k])
            console.log ("dau values" + dau.values()[eventName][k])
            _.each(kk, function(k){
              final[eventName][k] = dau.values()[eventName][k] / ga.values()[eventName][k]
            })
            console.log(final)
            
          })
          
          // $.when(getArray).done(function(array){
          //   $mau(array)
          // })
          
          // console.log($mau(d_a))

          // $.when($dau, $mau).done(function(dau, mau) {
          //   console.log(JSON.stringify(dau))
          //   console.log(JSON.stringify(mau))
          //   // console.log(mau.values()[eventName])
          //   var final_output = {}
          //   final_output[eventName] = {}
          //   var days = _.keys(mau.values()[eventName])
          //   var weeks = _.keys(dau.values()[eventName])
          //   _.each(weeks, function(week){
          //     var array = []
          //     var sum = 0
          //     for (var i = 0; i< 30; i++){
          //       var x = new Date(week).getTime() - i * 86400000
          //       var d = new Date(x).toISOString().substr(0, 10)
        //         array.push(d)
        //       }
        //       _.each(array, function(item){
        //         if (days.indexOf(item)!== -1){
        //         // console.log(mau.values()[eventName][item])
        //         sum+= mau.values()[eventName][item]
        //         }
        //       })
        //       console.log(sum)
        //       // final_output[eventName][week] = dau.values()[eventName][week]/sum
        //       if (sum > 0){
        //       final_output[eventName][week] = dau.values()[eventName][week]/sum
        //       }
        //     })
        //     console.log(days)
        //     console.log(weeks)
        //     console.log(JSON.stringify(final_output))
        //     // average the DAU values and divide them by the MAU ones
        //     // (we sum the MAU in the case where the 30 days spans over two months)
        //     // debugger
        //     var dauMau = dau.divide(mau.sum()).values();
        //     // console.log (dauMau)
        //     console.log(JSON.stringify(dauMau));
        //     $('#graph').MPChart({ // create chart
        //       chartType: 'line',                           // set its data
        //     });
        //     $('#graph2').MPChart({ // create chart
        //       chartType: 'line',                           // set its data
        //     });
        //     $('#graph').MPChart('setData', dauMau);
        //     $('#graph2').MPChart('setData', final_output);
        //   });
          
        };
     
    // });
    dateSelect.on('change', runQuery);
    </script>
  </body>
</html>